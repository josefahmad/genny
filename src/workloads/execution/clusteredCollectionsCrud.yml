# Run basic CRUD workload on a collection clustered by {_id: 1}

SchemaVersion: 2018-07-01
Owner: "@mongodb/server-execution"
Description: |
  TODO: TIG-3322

Actors:

# Phase 1: create collection
- Name: Create
  Type: RunCommand
  Threads: 1
  Phases:
  - Repeat: 1
    Database: test
    Operations:
    - OperationName: RunCommand
      OperationCommand:
        create: Collection0
        clusteredIndex: {key: {_id: 1}, unique: true}
  - &Nop {Nop: true}
  - *Nop
  - *Nop

# Phase 2: insert
- Name: Insert
  Type: Loader
  Threads: 1
  Phases:
  - *Nop
  - Repeat: 1
    Database: test
    Threads: 1
    CollectionCount: 1
    DocumentCount: 10000000
    BatchSize: 1000
    Document:
      # todo come up with a realistic distribution
      a: {^RandomDouble: {distribution: normal, mean: 145, sigma: 30.0}}
      b: {^RandomString: {length: 16}}
  - *Nop
  - *Nop

# Phase 3: create secondary index
- Name: AddSecondaryIndex
  Type: RunCommand
  Threads: 1
  Phases:
  - *Nop
  - *Nop
  - Repeat: 1
    Database: test
    Operations:
    - OperationName: RunCommand
      OperationCommand:
        createIndexes: Collection0
        indexes: [{key: {a: 1}, name: "a_1"}]
  - *Nop

# Phase 4: insert
- Name: Insert
  Type: Loader
  Threads: 1
  Phases:
  - *Nop
  - *Nop
  - *Nop
  - Repeat: 1
    Database: test
    Threads: 1
    CollectionCount: 1
    DocumentCount: 10000000
    BatchSize: 1000
    Document:
      # todo come up with a realistic distribution
      a: {^RandomDouble: {distribution: normal, mean: 145, sigma: 30.0}}
      b: {^RandomString: {length: 16}}

AutoRun:
- When:
    mongodb_setup:
      $eq:
      - atlas
      - replica
      - replica-all-feature-flags
      - single-replica
      - standalone
